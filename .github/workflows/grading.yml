name: Auto-Grader Bot
on:
  pull_request_target:
    paths: ['submissions/*.csv']

permissions:
  contents: read
  pull-requests: write

jobs:
  grade-submission:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout Organizer Repo (To get grader.py)
      - uses: actions/checkout@v3
        with:
          path: organizer

      # 2. Checkout Student Repo (To get their CSV)
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: student

      # 3. Setup Python
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 4. Install Libraries
      - run: pip install pandas scikit-learn

      # 5. Run The Grader
      - name: Calculate Score
        id: score_step
        env:
          SECRET_KEY: ${{ secrets.TEST_LABELS }}
        run: |
          # Find the CSV file
          FILE=$(find student/submissions -name "*.csv" | head -n 1)
          echo "Grading: $FILE"
          
          # Run script
          OUTPUT=$(python organizer/grader.py "$FILE")
          echo "Script output: $OUTPUT"
          
          # Extract score
          SCORE=$(echo "$OUTPUT" | grep "ACCURACY" | cut -d':' -f2)
          echo "final_score=$SCORE" >> $GITHUB_OUTPUT

      # 6. Post Comment
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          script: |
            const score = "${{ steps.score_step.outputs.final_score }}";
            let msg = "";
            
            if (score) {
               msg = `### ü§ñ Auto-Grader Report\n**Accuracy:** ${score}%\n\n`;
               if (parseFloat(score) > 75.0) msg += "üåü **DISTINCTION!** Amazing work.";
               else if (parseFloat(score) > 65.0) msg += "‚úÖ **PASSED!** Good job.";
               else msg += "‚ùå **KEEP TRYING.** You need >65% to pass.";
            } else {
               msg = "‚ö†Ô∏è **Error:** Could not grade file. Check your CSV format.";
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: msg
            });